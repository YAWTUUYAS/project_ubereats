{% extends "base.html" %}
{% block title %}Commande {{ order.id_commande }}{% endblock %}
{% block content %}
<div class="page-header">
  <h2>ğŸ“‹ Commande {{ order.id_commande }}</h2>
  <p class="muted">DÃ©tails et gestion de la commande</p>
</div>

<div class="order-details-section">
  <div class="order-info-card">
    <h3>ğŸ“‹ Informations gÃ©nÃ©rales</h3>
    <div class="info-grid">
      <div class="info-item">
        <span class="info-label">ğŸ‘¤ Client :</span>
        <span class="info-value">{{ order.nom_client or order.id_client or 'Client inconnu' }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">ğŸ“ Zone :</span>
        <span class="info-value">{{ order.zone }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">ğŸ  Adresse :</span>
        <span class="info-value">{{ order.livraison_adresse }}</span>
      </div>
      <div class="info-item">
        <span class="info-label">ğŸ“Š Statut :</span>
        <span class="status-badge status-{{ order.statut }}">{{ order.statut }}</span>
      </div>
      {% if order.statut == 'ANNULEE' and order.motif_annulation %}
        <div class="info-item">
          <span class="info-label">ğŸ“ Motif d'annulation :</span>
          <span class="info-value">{{ order.motif_annulation }}</span>
        </div>
      {% endif %}

      <div class="info-item">
        <span class="info-label">ğŸšš Livreur assignÃ© :</span>
        <span class="info-value">{{ order.id_livreur_assigne or 'Non assignÃ©' }}</span>
      </div>
    </div>
  </div>

  <div class="order-items-card">
    <h3>ğŸ½ï¸ Plats commandÃ©s</h3>
    {% if lignes %}
      <div class="items-list">
        {% for l in lignes %}
          <div class="item-row">
            <div class="item-info">
              <span class="item-name">{{ l.nom }}</span>
              <span class="item-quantity">Ã— {{ l.quantite }}</span>
            </div>
            <div class="item-price">{{ '%.2f'|format(l.quantite * l.prix_unitaire) }} â‚¬</div>
          </div>
        {% endfor %}
        <hr>
        <div class="order-summary">
          <div class="summary-line">
            <span>Sous-total plats :</span>
            <strong id="subtotal-plats">{{ sous_total_str }} â‚¬</strong>
          </div>
          <div class="summary-line">
            <span>Frais de livraison :</span>
            <strong id="frais-livraison-calc">0.00 â‚¬</strong>
          </div>
          <div class="summary-line total">
            <span>Total client :</span>
            <strong id="total-client">{{ total_client_str }} â‚¬</strong>
          </div>
        </div>
      </div>
    {% else %}
      <div class="empty-state">
        <p class="muted">Aucune ligne enregistrÃ©e.</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Script pour calculer les frais de livraison -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    function calculerFraisLivraison() {
        try {
            const sousTotalText = document.getElementById('subtotal-plats').textContent;
            const totalClientText = document.getElementById('total-client').textContent;
            
            const sousTotal = parseFloat(sousTotalText.replace('â‚¬', '').replace(',', '.').trim());
            const totalClient = parseFloat(totalClientText.replace('â‚¬', '').replace(',', '.').trim());
            
            if (isNaN(sousTotal) || isNaN(totalClient)) {
                throw new Error('Impossible de parser les montants');
            }
            
            const fraisLivraison = totalClient - sousTotal;
            
            // Validation
            if (fraisLivraison < 0) {
                console.warn('âš ï¸ Frais de livraison nÃ©gatifs:', fraisLivraison);
                document.getElementById('frais-livraison-calc').textContent = '0.00 â‚¬';
                document.getElementById('frais-livraison-calc').style.color = 'orange';
            } else {
                document.getElementById('frais-livraison-calc').textContent = fraisLivraison.toFixed(2) + ' â‚¬';
                document.getElementById('frais-livraison-calc').style.color = '';
            }
            
            console.log('âœ… Frais livraison calculÃ©s:', {
                sousTotal: sousTotal,
                totalClient: totalClient,
                fraisLivraison: fraisLivraison
            });
            
        } catch (error) {
            console.error('âŒ Erreur calcul frais livraison:', error);
            document.getElementById('frais-livraison-calc').textContent = 'Erreur';
            document.getElementById('frais-livraison-calc').style.color = 'red';
        }
    }
    
    // Calculer immÃ©diatement
    calculerFraisLivraison();
});
</script>

<!-- Le reste de votre code pour les actions restaurant -->
<div class="order-actions-section">
  {% if order.statut == 'CREEE' %}
    <div class="action-card">
      <h3>ğŸ“¢ Publier la commande</h3>
      <form method="post" action="{{ url_for('restaurant_publish', order_id=order.id_commande) }}">
        <div class="form-group">
          <label>ğŸ’° RÃ©munÃ©ration proposÃ©e (â‚¬)</label>
          <input name="remuneration" placeholder="Ex: 8.50" required type="number" step="0.01" min="0">
        </div>
        <button type="submit" class="btn btn-primary">ğŸ“¢ Publier</button>
      </form>
    </div>
  {% endif %}

  {% if order.statut == 'ANONCEE' and interets %}
    <div class="action-card">
      <h3>ğŸ‘¥ Livreurs intÃ©ressÃ©s</h3>
      <div class="interets-list">
        {% for i in interets %}
          <div class="interet-item">
            <div class="interet-info">
              <span class="livreur-name">Livreur {{ i.id_livreur }}</span>
              <span class="eta-info">ETA {{ i.temps_estime or '-' }} min</span>
            </div>
            <form method="post" action="{{ url_for('restaurant_assign', order_id=order.id_commande) }}">
              <input type="hidden" name="livreur_id" value="{{ i.id_livreur }}">
              <button type="submit" class="btn btn-success">âœ… Assigner</button>
            </form>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if order.statut in ['CREEE','ANONCEE','ASSIGNEE'] %}
    <div class="action-card danger">
      <h3>âŒ Annuler la commande</h3>
      <form method="post" action="{{ url_for('restaurant_cancel', order_id=order.id_commande) }}">
        <div class="form-group">
          <label>Motif d'annulation</label>
          <input name="motif" placeholder="Ex: Produit indisponible" required>
        </div>
        <button type="submit" class="btn btn-outline-danger">âŒ Annuler</button>
      </form>
    </div>
  {% endif %}
</div>

<div class="back-link">
  <a href="{{ url_for('restaurant_dashboard') }}" class="btn btn-outline-primary">â† Retour au tableau de bord</a>
</div>
{% endblock %}